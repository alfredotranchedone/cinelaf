- pipeline: "On Push: Test Php & Build js"
  trigger_mode: "SCHEDULED"
  ref_name: "master"
  ref_type: "BRANCH"
  start_date: "2020-04-13T10:00:00.000Z"
  delay: 1440
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: php artisan test"
    type: "BUILD"
    working_directory: "/buddy/cinelaf"
    docker_image_name: "library/php"
    docker_image_tag: "7.2.5"
    execute_commands:
    - "cp .env.buddyworks .env"
    - ""
    - "composer install"
    - ""
    - "php artisan key:generate"
    - "php artisan migrate --no-interaction -vvv"
    - ""
    - "# vendor/bin/phpunit"
    - "php artisan test"
    setup_commands:
    - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "# php ext gd"
    - "apt-get install -y libfreetype6-dev"
    - "apt-get install -y libjpeg62-turbo-dev"
    - "apt-get install -y libpng-dev"
    - "docker-php-ext-configure gd --with-freetype --with-jpeg --with-gd --with-jpeg-dir --with-png-dir --with-zlib-dir"
    - "docker-php-ext-install gd"
    - "# php ext zip"
    - "apt-get install -y zip"
    - "apt-get install -y unzip"
    - "apt-get install -y zlib1g-dev"
    - "apt-get install -y libzip-dev"
    - "docker-php-ext-install zip"
    - "# php ext pdo_mysql"
    - "docker-php-ext-configure pdo_mysql --with-pdo-mysql"
    - "docker-php-ext-install pdo_mysql"
    services:
    - type: "MARIADB"
      version: "10.4"
      connection:
        host: "mariadb"
        port: 3306
        user: "root"
        password: "test"
        db: "test"
    volume_mappings:
    - "/:/buddy/cinelaf"
    trigger_condition: "ALWAYS"
    shell: "BASH"
    run_next_parallel: true
  - action: "Execute: npm run prod"
    type: "BUILD"
    working_directory: "/buddy/cinelaf"
    docker_image_name: "library/node"
    docker_image_tag: "12"
    execute_commands:
    - "npm install"
    - ""
    - "npm run prod"
    volume_mappings:
    - "/:/buddy/cinelaf"
    trigger_condition: "ALWAYS"
    shell: "BASH"
